## Android逆向



[TOC]

<!-- TOC -->

- [Android逆向](#android%e9%80%86%e5%90%91)
- [打包文件](#%e6%89%93%e5%8c%85%e6%96%87%e4%bb%b6)
- [工具](#%e5%b7%a5%e5%85%b7)
- [安装](#%e5%ae%89%e8%a3%85)
- [使用](#%e4%bd%bf%e7%94%a8)
  - [apktool.bat使用](#apktoolbat%e4%bd%bf%e7%94%a8)
  - [dex2jar使用](#dex2jar%e4%bd%bf%e7%94%a8)
  - [jd-gui使用](#jd-gui%e4%bd%bf%e7%94%a8)
- [Miasm（逆向工程平台）](#miasm%e9%80%86%e5%90%91%e5%b7%a5%e7%a8%8b%e5%b9%b3%e5%8f%b0)
- [radare2（逆向工程平台）](#radare2%e9%80%86%e5%90%91%e5%b7%a5%e7%a8%8b%e5%b9%b3%e5%8f%b0)
- [参考](#%e5%8f%82%e8%80%83)

<!-- /TOC -->

<br/>

## 打包文件

assets

- 资源文件，如声音、字体等等。
- 代码中使用AssetsManager获取Assets文件夹的资源。

<br/>

lib

- 存放用C/C++编写的，用NDK编译生成的so文件，供java/kotlin端调用。

<br/>

META-INF

- 存放apk签名信息，用来保证包的完整性和系统的安全。
- 在IDE编译生成一个apk包时，会对里面所有的文件做一个校验计算，并把计算结果存放在META-INF文件夹内，apk在安装的时候，系统会按照同样的算法对apk包里面的文件做校验，如果结果与META-INF里面的值不一样，系统就不会安装这个apk，这就保证了apk包里的文件不能被随意替换。比如拿到一个apk包后，如果想要替换里面的一幅图片，一段代码， 或一段版权信息，想直接解压缩、替换再重新打包，基本是不可能的。如此一来就给病毒感染和恶意修改增加了难度，有助于保护系统的安全。

<br/>

res

- 存放资源文件，包括icon，xml文件

<br/>

AndroidManifest.xml

- 应用配置文件，每个应用都必须定义和包含，它描述了应用的名字、版本、权限、引用的库等。

<br/>

classes.dex

- 可以直接在Dalvik虚拟机上加载运行的文件，由java/kotlin文件经过IDE编译生成。
- Dalvik虚拟机的指令码不是标准的Jvm指令码，而是使用了自己独有的一套指令集（类似汇编语言）。
- dex文件中共用了很多类名称，常量字符串，使它的体积更小，运行效率更高。

<br/>

resources.arsc

- 二进制资源文件，包括字符串等。

<br/>



<br/>

## 工具

- apktool
  - 编译和反编译apk，从apk中提取图片和布局资源
- dex2jar
  - 将可运行文件classes.dex反编译为jar源码文件
- jd-gui
  - 查看jar源码文件

<br/>

<br/>

## 安装

apktool下载：https://bitbucket.org/iBotPeaches/apktool/downloads/

apktool.bat下载： [包装程序脚本](https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/windows/apktool.bat)（右键单击，将链接另存）

将两个文件放置统一目录，并添加到系统环境变量中

<br/>

<br/>

## 使用

### apktool.bat使用

反编译

> apktool.bat d -o <output_dir> test.apk

如果输出路径存在添加`-f`  ：  例如：`apktool.bat d -f -o ./output/ app-debug.apk`

编译

> apktool.bat b -o <output.apk> <input_dir>

<br/>

### dex2jar使用

> - dex-reader旨在读取Dalvik Executable（.dex / .odex）格式。它具有类似于ASM的轻量级API。
> - dex-translator设计用于执行转换工作。它将dex指令读取为dex-ir格式，经过一些优化后，转换为ASM格式。
> - dex-translator使用的dex-ir旨在表示dex指令
> - dex-tools工具可用于.class文件。
> - d2j-smali将dex分解为smali文件，并从smali文件组装dex。与smali / baksmali的实现方式不同，语法相同，但是我们在描述“ Lcom / dex2jar \ t \ u1234;”类型中支持转义。
> - dex-writer与dex-reader一样写dex。

<br/>

命令

`sh d2j-dex2jar.sh -f ~/path/to/apk-debug.apk`

<br/>

### jd-gui使用

下载：http://java-decompiler.github.io/

使用jd-gui打开classes-dex2jar.jar，查看源码。

<br/>



<br/>

## Miasm（逆向工程平台）

Miasm是一个免费并且开放源代码的逆向工程平台，Miasm的目标是分析/修改/生成二进制代码。

特点：

> 1. 使用Elfesteem打开/修改/生成PE/ELF 32/64文件；
> 2. 组装/拆卸ia32/ppc/arm；
> 3. 使用中间语言表示汇编语义；
> 4. 使用jit进行仿真（动态代码分析，解压缩等）；
> 5. 简化表达以自动消除混淆；
> 6. 使用Grandalf的图形反汇编程序。

<br/>

## radare2（逆向工程平台）

也是一款开放源代码的逆向工程平台，它可以反汇编、调试、分析和操作二进制文件。

特点：

> 1. 多架构多平台。
> 2. 高度脚本化。
> 3. 十六进制编辑器。
> 4. IO包装。
> 5. 文件系统支持。
> 6. 调试器支持。
> 7. 两个函数或二进制文件之间的区别。
> 8. 在操作码，基本块，功能级别进行代码分析。

<br/>



<br/>

## 参考

https://juejin.im/post/5e9525cff265da47b27d948a

https://sourceforge.net/projects/dex2jar/

https://www.linux110.com/ruanjian/1245.html

<br/>